-- Author:  Kevin Thomas, Assistant Registrar
--   Date:    19-DEC-2019
--Purpose: This query returns VA students that have a final grade of F or FA by prompted term.  It
--         also includes instructor preferred contact email addresses.  
--   Note: There is some duplication of CRNs if instructors have more than 1 preferred email type checked 
--         on SPAIDEN.  

--desc ssbsect;
--desc sfrstcr;
--desc sgrvetn;
--desc SIRASGN;
--desc goremal;


select sfrstcr_term_code as "Term",
       SP.spriden_id as "ID",
       SPBPERS_SSN as "SSN",
       SP.spriden_last_name  as "Last Name",
       SP.spriden_first_name as "First Name", 
       sfrstcr_crn as "CRN",
       ssbsect_subj_code as "Subj",
       ssbsect_crse_numb as "Numb",
       SSBSECT_CAMP_CODE  as "Campus",
       SFRSTCR_CREDIT_HR as "Hours",
       ssbsect_seq_numb as "Section",
       sfrstcr_ptrm_code as "PTRM Code",
       sfrstcr_grde_code as "Grade",
       sfrstcr_last_attend  as "LDA",
      -- sgrvetn_vetc_code as "Veteran Type",
       STVVETC_DESC as "Vet Code Description"--,
      -- I.spriden_id as "Instructor ID",
      -- I.spriden_first_name || ' '|| I.Spriden_last_name as Instructor,
     --  GOREMAL_EMAL_CODE as "Email Type",
      -- GOREMAL_EMAIL_ADDRESS as "Instructor Preferred Email"

from sfrstcr, spriden SP, ssbsect, sgrvetn, SPBPERS, stvvetc--, sirasgn, goremal, Spriden I
where SP.spriden_change_ind IS NULL 
--and   I.spriden_change_ind is null
--and   I.spriden_pidm = goremal_pidm (+)
and   SP.spriden_PIDM = SPBPERS_PIDM
and   sgrvetn_pidm = SP.spriden_pidm
and   spbpers_pidm = SP.spriden_pidm
and   sfrstcr_pidm = SP.spriden_pidm 
and   SP.spriden_pidm = sgrvetn_pidm
--and   I.spriden_pidm = sirasgn_pidm
--and   SIRASGN_PRIMARY_IND = 'Y'
--and   SIRASGN_TERM_CODE = :Term
--and   SIRASGN_CRN = sfrstcr_crn
and   sfrstcr_crn = ssbsect_crn
and   STVVETC_CODE = sgrvetn_vetc_code
and   sfrstcr_term_code = :Term
and   SGRVETN.SGRVETN_TERM_CODE_VA = :Term
and   sfrstcr_term_code = ssbsect_term_code
and   sgrvetn_vetc_code IN ('T','U','1', '5', 'C', 'D', 'H', 'L')
and   (sfrstcr_grde_code = 'F' or SFRSTCR_grde_code = 'FA')
--and   (GOREMAL_EMAL_CODE  (+) = 'BUSN' or GOREMAL_EMAL_CODE  (+) = 'PERS' or GOREMAL_EMAL_CODE  (+) = 'CAMP')
--and   GOREMAL_STATUS_IND  (+) <> 'I'
--and   GOREMAL_PREFERRED_IND  (+) = 'Y'

order by SFRSTCR_grde_code desc, sgrvetn_vetc_code, SP.spriden_last_name, SP.spriden_first_name, sfrstcr_ptrm_code, sfrstcr_crn